services:
  mongo:
    image: mongo:7.0
    container_name: mongodb
    restart: unless-stopped

    env_file:
      - .env
    environment:
      MONGODB_URL: ${MONGODB_URL}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME}
      PORT: ${PORT}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS}
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS}

    volumes:
      - mongo_data:/data/db

    # Don't expose Mongo publicly unless you explicitly need it
    # ports:
    #   - "27017:27017"

    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "--quiet",
          "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@localhost:27017/admin?authSource=admin",
          "--eval",
          "db.runCommand({ ping: 1 })",
        ]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

  app:
    build: .
    container_name: backend-core
    restart: unless-stopped

    env_file:
      - .env

    # If your app reads PORT, this keeps it consistent
    environment:
      - PORT=${PORT}

    depends_on:
      mongo:
        condition: service_healthy

    expose:
      - "8000"

  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

    depends_on:
      - app

volumes:
  mongo_data:
  caddy_data:
  caddy_config:
